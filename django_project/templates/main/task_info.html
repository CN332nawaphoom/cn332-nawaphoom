{% extends 'main/base.html' %}
{% load static %}

{% block title %}Task info{% endblock title %}
{% comment %} {% block extra_head %}
<link rel="stylesheet" href="{% static 'css/navbar.css' %}">
<style>
   
    #video-container {
        position: relative;
        display: flex;
        flex-direction: column;
        margin-left: 500px;
        margin-bottom: 50px;
    }

    #config {

        display: flex;
        flex-direction: row;

    }
</style>
{% endblock extra_head %} {% endcomment %}

{% block navbar %}{% include 'main/navbar-with-search.html' %}{% endblock navbar %}

{% block body %}
    <div class="container mt-4 gap-2">
        <div class="row row-cols-1 d-flex justify-content-center">

            {% comment %} video and config {% endcomment %}
            <div class="row row-cols-md-2">
                <div class="col col-md-7" id="video-container">
                    <video id="myVideo" width="100%">
                        <source src="{{ task.video.url }}" type="video/mp4" >
                    </video>
                </div>

                    {% comment %} config {% endcomment %}
                <div class="col col-md-5 d-none d-md-block" >
                    <p>Coordinates(x,y): <span id="coordinates">x, y</span></p>
                    <div id="pointer"></div>
                    
                    <div id="config">
                        <ul id="filledCoordinates" style="margin-right: 30px;">
                            <p>added list</p>
                        </ul> 

                        <form name="myfillform" id="myfillform" method="post"  action="{% url 'process' id=task.id %}">
                            {% csrf_token %}
                            <label for="coordinates1">coordinates1</label>
                            <input type="text" id="coordinates1" name="coordinates1" onclick="setSelectedInput(this)" onfocus="setSelectedInput(this)" ><br>
                            <label for="coordinates2">coordinates2</label>
                            <input type="text" id="coordinates2" name="coordinates2" onclick="setSelectedInput(this)" onfocus="setSelectedInput(this)" ><br>
                            <label for="coordinates3">coordinates3</label>
                            <input type="text" id="coordinates3" name="coordinates3" onclick="setSelectedInput(this)" onfocus="setSelectedInput(this)" ><br>
                            <label for="coordinates4">coordinates4</label>
                            <input type="text" id="coordinates4" name="coordinates4" onclick="setSelectedInput(this)" onfocus="setSelectedInput(this)" ><br>

                            <input type="button" id='addButton' value="add" style="margin-left: 85px; margin-top: 10px;">

                        </form>

                        <div id="select_model" style="margin-left: 30px;">
                            <label for="dropdown">Select model</label><br>
                            <select id="dropdown" required>
                                <option value="YOLOV8">YOLOV8</option>
                                <option value="YOLOV7">YOLOV7</option>
                                <option value="YOLOV6">YOLOV6</option>
                            </select>
                            <input id="process" type="submit" value="process">
                        </div>
                    </div>
                </div>
            </div>


            
            {% comment %} large screen {% endcomment %}
            <div class="col table-responsive d-none d-md-block">
                <table class="table table-striped text-center">
                    <thead class="text-nowrap">
                        <tr>
                            <th>Intersection</th>
                            <th>Province</th>
                            <th>Status</th>
                            <th>Date Added</th>
                            <th>Date Modified</th>
                            <th>Uploaded By</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider align-middle text-nowrap">
                        <tr>
                            <td>{{ task.intersection_name }}</td>
                            <td>{{ task.province }}</td>
                            <td>status</td>
                            <td>{{ task.date_created }}</td>
                            <td>{{ task.date_modified }}</td>
                            <td>{{ task.uploaded_by }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            {% comment %} small screen {% endcomment %}
            <div class="col table-responsive d-md-none">
                <table class="table table-striped text-center">
                    <tr>
                        <th>Intersection</th>
                        <td>{{ task.intersection_name }}</td>
                    </tr>
    
                    <tr>
                        <th>Province</th>
                        <td>{{ task.province }}</td>
                    </tr>
    
                    <tr>
                        <th>Status</th>
                        <td>status</td>
                    </tr>
    
                    <tr>
                        <th>Date Added</th>
                        <td>{{ task.date_created }}</td>
                    </tr>
    
                    <tr>
                        <th>Date Modified</th>
                        <td>{{ task.date_modified }}</td>
                    </tr>
    
                    <tr>
                        <th>Upload By</th>
                        <td>{{ task.uploaded_by }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>





        
    </div>


    
    <script>
        const videoContainer = document.getElementById('video-container');
        const defaultwidth = document.getElementById('myVideo');
        const defaultheight = document.getElementById('myVideo').height;
        console.log(defaultwidth)
        console.log(defaultheight)
        const pointer = document.getElementById('pointer');
        const coordinates = document.getElementById('coordinates');
        let send = document.getElementById('process');
        let form = document.getElementById('myfillform');
        let selectedInput = null
        let filledCoordinatesLists = [];
        let count = 0;

        // Get the <ul> element by its id
        const coordinatesList = document.getElementById("filledCoordinates");

        
        function updatelist(index) {
            let coor = filledCoordinatesLists[index];
                
            const listItem = document.createElement("li");

            listItem.textContent = `(${coor["coordinates1"]}), (${coor["coordinates2"]}), (${coor["coordinates3"]}), (${coor["coordinates4"]})`;

            coordinatesList.appendChild(listItem);
           
        };

        
        // Function to update pointer position and display coordinates
        function updatePointer(event,select) {
            const rect = videoContainer.getBoundingClientRect();
            const x = Math.round(event.clientX - rect.left);
            const y = Math.round(event.clientY - rect.top);
            pointer.style.left = x + 'px';
            pointer.style.top = y + 'px';
            coordinates.textContent = x + ', ' + y;
            pointer.style.display = 'block';
    
            // Update form fields with coordinates
            
            if (selectedInput) {
            selectedInput.value = x + ', ' + y;
            }
        }
            
    
        function move(event) {
            const rect = videoContainer.getBoundingClientRect();
            const x = Math.round(event.clientX - rect.left);
            const y = Math.round(event.clientY - rect.top);
            pointer.style.left = x + 'px';
            pointer.style.top = y + 'px';
            coordinates.textContent = x + ', ' + y;
            pointer.style.display = 'block';
        }
        // Event listener for mouse click
        videoContainer.addEventListener('click', function(event) {
            if (selectedInput) {
                selectedInput.focus();
            }
            updatePointer(event);
        });

        // Function to set the selected input field
        function setSelectedInput(input) {
            selectedInput = input;
        
        }   
    
        videoContainer.addEventListener('mousemove', move);
    
        function addform(){

            // Get the filled values
            const coordinatesObj = {
                coordinates1: document.getElementById('coordinates1').value,
                coordinates2: document.getElementById('coordinates2').value,
                coordinates3: document.getElementById('coordinates3').value,
                coordinates4: document.getElementById('coordinates4').value
            };

            filledCoordinatesLists.push(coordinatesObj);


            //clear after adding
            document.getElementById('coordinates1').value = '';
            document.getElementById('coordinates2').value = '';
            document.getElementById('coordinates3').value = '';
            document.getElementById('coordinates4').value = '';
        
        };
        
        
        document.getElementById('addButton').addEventListener('click', function(event) {
            addform()
            updatelist(count)
            count++;
        });   
        
        send.addEventListener('click', function(event) {
            // Add the list of added coordinates as a hidden input field
            // Get the dropdown element
            let dropdown = document.getElementById('dropdown');

            // Get the selected option value
            let selectedmodel = dropdown.options[dropdown.selectedIndex].value;

            // Log the selected option value to the console
            console.log(selectedmodel);
            console.log("send")


            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'Coordinates&model';
            
            hiddenInput.value = JSON.stringify({
                model: selectedmodel,
                CoordinatesLists: filledCoordinatesLists
            });

            form.appendChild(hiddenInput);

            form.submit();
        });
    </script>
    
{% endblock body %}